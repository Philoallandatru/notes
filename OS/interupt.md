# 中断

## 图示

### before

### after

## 中断向量

### 

## 中断的分类

### 分类（简要版）

- 内中断（也称异常、例外、陷入）

	- 自愿中断————指令中断

		- 系统调用时使用的访管指令（又叫陷入指令、Trap指令）

	- 强迫中断

		- 硬件故障

			- 如缺页

				- 可修复

		- 软件故障

			- 整除0
			- 越权、越级、溢出

	- 解释

		- 信号来源于CPU内部或与当前执行的指令有关

- 外中断（中断）

	- 外设请求

		- 例如I/O完成发出中断请求，比如DMA结束

	- 人工干预

		- 用户强行（Cntrl + C）中断一个程序

	- 解释

		- 信号来源与CPU外部，与当前指令无关

### 分类（详细版）

- 内中断（内部异常）

	- 陷阱、陷入（Trap）

		- 执行陷阱指令(自陷指令)时，CPU调出特定程序进行相应处理，处理结束后返回到陷阱指令下一条指令执行

			- 

		- 例如

			- 系统调用（访管指令）
			- 单步跟踪
			- 断点

		- 单步跟踪和断点的实现

			- 通过“埋地雷”的方式实现
			- IA-32中，当CPU处于单步跟踪状态(TF=1且IF=1)时，每条指令 都被设置成了陷阱指令，执行每条指令后，都会发生中断类型号为1 的“调试”异常，从而转去执行“单步跟踪处理程序”

				- 注意: 当陷阱指令是转移指令时，不能返回到转移指令的下条指令执 行，而是返回到转移目标指令执行。
				- (在一定的条件下，每条指令都变成“地雷”)

			- IA-32中，用于程序调试的“断点设置”陷阱指令为int 3，对应机器 码为CCH。若调试程序在被调试程序某处设置了断点，则调试程序就 在该处“加”一条int 3指令(该首字节)。执行到该指令时，会暂停 被调试程序的运行，并发出“EXCEPTION_BREAKPOINT”异常， 以调出调试程序执行，执行结束后回到被调试程序执行
			- (int 3是一定爆炸的“地雷”)
			- IA-32的标志寄存器

				- 6个条件标志

					- OF、SF、ZF、CF各是什么标志(条件码)
					- AF:辅助进位标志(BCD码运算时才有意义)
					- PF:奇偶标志

				- 3个控制标志

					- DF(Direction Flag):方向标志(自动变址方向是增还是减)
					- IF(Interrupt Flag):中断允许标志 (仅对外部可屏蔽中断有用)
					- TF(Trap Flag):陷阱标志(是否是单步跟踪状态)

		- 作用

			- 提供系统调用

			  陷阱的作用之一是在用户和内核之间提供一个像过程一样的接口，这个 接口称为系统调用，用户程序利用这个接口可方便地使用操作系统内核 提供的一些服务。操作系统给每个服务编一个号，称为系统调用号。例 如，Linux系统调用fork、read和execve的调用号分别是1、3和11
			  
		- 陷阱指令示例

			- IA-32处理器中的 int 指令和 sysenter 指令
			- MIPS处理器中的 syscall指令
			- 陷阱指令异常称为编程异常(programmed exception)
			- 包括

				- into(溢出检查)
				- bound(地址越界检查)
				- INT n
				- int 3

		- 具体的例子：“open()”

			- 起因

				- 用户程序中调用函数 open(filename, options)
				- open函数执行陷阱指令(即系统调用指令“int”)
				- 

			- 系统调用

	- 故障（Fault）

		- 由指令执行、错误条件引起的，可以被故障或者异常处理程序修复
		- 包括

			- 缺页
			- TLB缺失
			- 溢出
			- 非法指令
			- 访问越权
			- 页故障

				- 一般过程

					- 每条指令都要访存（取指令、取操作数、存结果）
					- 在保护模式下，每次访存都要进行逻辑地址到物理地址的转换
					- 在地址转换的过程中检查是否发生了缺页
					- 由于这种地址转换是由MMU（硬件设备）实现的，所以页缺故障事件由硬件发现
					- 注意，有异常和中断事件都由硬件检测发现

				- 三种情况

					- 缺页：页表有效位为0
					-  地址越界:地址大于最大界限
					- 访问越级或越权(保护违例)

						- 越级:用户进程访问内核数据(CPL=3 / DPL=0)
						- 越权:读写权限不相符(如对只读段进行了写操作)

	- 终止（abort）

		- 不可恢复的致命错误造成的结果，终止处理程序将不再将控制权返回给引发终止的程序，比如整数除0
		- 例如

			- 校验错误
			- 掉电

- 外中断

	- I/O中断请求
	- 人工干预

## 中断

### 中断的概念

- 外设通过中断请求信号线向CPU提出“中断”请求，不由指令引起，故中断 也称为异步异常
- 引发中断的事件

	- Ctrl-C
	- DMA传送结束
	- 网络数据到达
	- 打印缺纸

### 中断的检测和响应

- CPU如何检测中断

	- 每执行完一条指令，CPU就查看中断请求引脚（来自总线引脚），若引脚的信号有效，则进行 中断响应

- 如果检测到了中断信号如何响应

	- 一句话：将当前PC(断点)和当前机器状态保存到栈中，并“关中断”， 然后，从数据总线读取中断类型号，根据中断类型号跳转到对应的中断服务程序执行

		- 

	- 三个步骤

		- 1. 关中断(“中断允许位” 清0)

			- 使CPU处于“禁止中断”状态，以防止 新中断破坏断点(PC)、程序状态(PSW)和现场(通用寄存器)

		- 2.  保护断点(将断点和程序状态保存到栈或特殊寄存器中)

			- PC→栈 或 EPC(专门存放断点的寄存器)

				- PSW(Program Status Word):程序状态字

			- PSWR →栈 或 EPSWR (专门保存程序状态的寄存器

				- PSWR(PSW寄存器):如IA-32中的的EFLAGS寄存器

		- 3. 识别中断事件，转中断处理

			- 有软件识别和硬件识别(向量中断)两种不同的方式
			- （1）软件识别(MIPS采用)

				- 设置一个异常状态寄存器(MIPS中为Cause寄存器)，用于记录异常 原因。操作系统使用一个统一的异常处理程序，该程序按优先级顺序 查询异常状态寄存器，识别出异常事件。
				- (例如:MIPS中位于内核地址0x8000 0180处有一个专门的异常处 理程序，用于检测异常的具体原因，然后转到内核中相应的异常处理 程序段中进行具体的处理)

			- （2）硬件识别(向量中断)(IA-32采用)

				- 用专门的硬件查询电路按优先级顺序识别异常，得到“中断类型号” ，根据此号，到中断向量表中读取对应的中断服务程序的入口地址。
				- 所有事件都被分配一个“中断类型号”，每个中断都有相应的“中 断服务程序”，可根据中断类型号找到中断服务程序的入口地址。
				- 中断类型号相当于中断向量表的索引，表中存放中断服务程序首地址

- 之后

	- 中断服务程序执行具体的中断处理工作，中断处理完成后，再回到被打断程 序的“断点”处继续执行

### 按可否屏蔽分类

- 可屏蔽中断(maskable interrupt)

	- 通过 INTR 向CPU请求，可通过设置屏蔽字来屏蔽 请求，若中断请求被屏蔽，则不会被送到CPU

- 不可 屏蔽中断(nonmaskable interrupt，NMI)

	- 非常紧急的硬件故障，如:电源掉电，硬件线路 故障等。通过 NMI 向CPU请求。一旦产生，就被立即送CPU， 以便快速处理。这种情况下，中断服务程序会尽快保存系统重要 信息，然后在屏幕上显示相应的消息或直接重启系统

		- 对应两种中断有两个引脚

### IA-32的向量中断方式

- 简介

	- 有256种不同类型的异常和中断，每个异常和中断都有唯一编号，称之为中断类型号(也称向量号)。 如类型0为“除法错”，类型2为“NMI中断”，类型14为“缺页”

		- 前32个类型(0~31)保留给CPU使用，剩余的由用户自行定义(这 里的用户指机器硬件的用户，即操作系统)
		- 通过执行INT n(指令第二字节给出中断类型号n，n=32~255)使 CPU自动转到OS给出的中断服务程序执行

	- 每个异常和中断有与其对应的异常处理程序或中断服务程序，其入口 地址放在一个专门的中断向量表或中断描述符表中。
	- 描述方式

		- 实模式下，用中断向量表描述
		- 保护模式下，用中断描述符表描述

- 中断类型

	- 用户自定义类型号为 32~255，部分用于可屏 蔽中断，部分用于软中断
	- 可屏蔽中断通过CPU的 INTR 引脚向CPU发出中 断请求
	- 软中断指令 INT n 被设 定为一种陷阱异常，例如 ，Linux通过int $0x80 指令将128号设定为系统 调用，而Windows通过 int $0x2e指令将46号设 定为系统调用。

- 实地址模式下的中断向量表

	- 实地址模式(Real Mode)是Intel为80286及其之后的处理器提供的一种 8086兼容模式。寻址空间1MB，指令地址=CS<<4+IP 。中断向量表位于 0000H~03FFH。共256组，每组占四个字节 CS:IP

		-  实地址模式下没有分页管理机制!
		- 中断向量表中每一项是对应中断服务程序或异常处理程序的入口地址， 被称为中断向量(Interrupt Vector)。

	- 开机过程

		- 开机后系统首先在实地址模式下工作(只有1MB的寻址空间)
		- 开机过程中，需要先准备在实模式下的中断向量表和中断服务程序。通常，由固化在主板上一块ROM芯片中的BIOS程序完成

			- BIOS

				- BIOS(Basic Input/Output System)是基本输入/输出系统的简称， 是针对具体主板设计的，与安装的操作系统无关。
				- BIOS包含各种基本设备驱动程序，通过执行BIOS程序，基本设备驱动程 序以中断服务程序的形式被加载到内存，以提供基本I/O系统调用。

		- BIOS程序检测显卡、键盘、内存等，并在00000H~003FFH区建立中
断向量表，在中断向量所指主存区建立相应的中断服务程序
		- BIOS利用INT指令执行特定的中断服务程序把OS从磁盘加载到内存中。 例如，BIOS可通过执行int 0x19指令来调用中断向量0x19对应的中断 服务程序，将启动盘上的0号磁头对应盘面的0磁道1扇区中的引导程序装 入内存
		- 一旦进入保护模式，就不再使用BIOS

- 保护模式下的中断描述符表

	- 保护模式下，通过中断描述符表获异常处理或中断服务程序入口地址
	- 中断描述符表(Interrupt Descriptor Table，IDT)是OS内核中的一个表，共有256个表项，每个表项占8个字节，IDT共占用2KB
	- 

